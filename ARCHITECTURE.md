# 🏗️ Архитектура расширения Avito Hunter

## 📋 Общая схема

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Popup UI      │    │  Background     │    │  Content Script │
│   (popup.js)    │◄──►│   (background.js)│◄──►│   (content.js)  │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Settings      │    │   Timer         │    │   DOM Parser    │
│   Storage       │    │   Management    │    │   Avito Items   │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │
                                ▼
                       ┌─────────────────┐
                       │  Telegram API   │
                       │   Notifications │
                       └─────────────────┘
```

## 🔧 Компоненты системы

### 1. Popup Interface (popup.js + popup.html)
- **Назначение**: Пользовательский интерфейс для настройки
- **Функции**:
  - Ввод токена Telegram бота
  - Ввод ID чата
  - Выбор интервала обновления
  - Запуск/остановка отслеживания
  - Отображение статистики

### 2. Background Script (background.js)
- **Назначение**: Основная логика расширения
- **Функции**:
  - Управление таймерами обновления
  - Отправка запросов в Telegram API
  - Координация между компонентами
  - Обработка событий браузера

### 3. Content Script (content.js)
- **Назначение**: Парсинг страниц Avito
- **Функции**:
  - Извлечение данных объявлений
  - Сравнение с кешированными данными
  - Обнаружение новых элементов
  - Сохранение кеша

## 🔄 Поток данных

### Инициализация
1. Content script загружается на странице Avito
2. Парсит все объявления и сохраняет в кеш
3. Уведомляет background script о готовности

### Отслеживание
1. Background script запускает таймер
2. По истечении интервала обновляет страницу
3. Content script парсит обновленную страницу
4. Сравнивает с кешем и находит новые элементы
5. Отправляет новые элементы в background script
6. Background script отправляет уведомления в Telegram
7. Кеш обновляется новыми элементами

## 💾 Хранение данных

### Browser Storage
- **settings**: Настройки пользователя
  - telegramBotToken
  - telegramChatId
  - refreshInterval
  - isEnabled
  - trackedTabs

- **cachedItems**: Кеш объявлений
  - Ключ: href объявления
  - Значение: объект с данными объявления

## 🔌 API интеграции

### Telegram Bot API
- **Endpoint**: `https://api.telegram.org/bot{token}/sendMessage`
- **Метод**: POST
- **Данные**: JSON с chat_id и text
- **Формат**: HTML разметка для форматирования

### Avito DOM
- **Селекторы**:
  - `a.iva-item-sliderLink` - ссылки на объявления
  - `meta[itemprop="description"]` - описание
  - `meta[itemprop="price"]` - цена
  - `h2[itemprop="name"] a` - название

## ⚡ Производительность

### Оптимизации
- Кеширование данных в localStorage
- Использование href как уникального ID
- Асинхронная обработка сообщений
- Минимальные DOM запросы

### Ограничения
- Работает только на avito.ru
- Зависит от структуры DOM Avito
- Ограничения Telegram API (30 сообщений/сек)

## 🛡️ Безопасность

### Permissions
- `storage` - для кеширования данных
- `tabs` - для управления вкладками
- `activeTab` - для доступа к активной вкладке
- `https://api.telegram.org/*` - для отправки уведомлений
- `https://www.avito.ru/*` - для работы на Avito

### Защита данных
- Токены хранятся локально
- Нет передачи данных на внешние серверы (кроме Telegram)
- Валидация входных данных

## 🔄 Жизненный цикл

1. **Установка**: Загрузка manifest.json
2. **Инициализация**: Запуск background и content scripts
3. **Настройка**: Пользователь вводит параметры
4. **Отслеживание**: Циклическое обновление и проверка
5. **Уведомления**: Отправка в Telegram при изменениях
6. **Остановка**: Пользователь останавливает отслеживание
